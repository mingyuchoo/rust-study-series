{% extends "base.html" %}

{% block title %}{{ indicator.name }} - ì„±ê³¼ì§€í‘œ ìƒì„¸{% endblock %}

{% block content %}
<div class="card mt-20">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>{{ indicator.name }}</h2>
        <span
            class="score-badge {% if score >= 80 %}score-high{% elif score >= 50 %}score-mid{% else %}score-low{% endif %}">
            ì¢…í•©ì ìˆ˜: {{ score | round(precision=1) }}%
        </span>
    </div>

    <!-- ì •ë³´ + ê²Œì´ì§€ ì°¨íŠ¸ ì„¹ì…˜ -->
    <div style="display: flex; gap: 30px; align-items: flex-start; margin-top: 20px;">
        <!-- ì™¼ìª½: ì •ë³´ ê·¸ë¦¬ë“œ -->
        <div class="grid-2" style="flex: 1;">
            <div><strong>ì—°ë„:</strong> {{ indicator.year }}</div>
            <div><strong>ë‹¨ìœ„:</strong> {{ indicator.unit | default(value="â€”") }}</div>
            <div><strong>ëª©í‘œê°’:</strong> {{ indicator.target_value | default(value="â€”") }}</div>
            <div><strong>ì‹¤ì ê°’:</strong> {{ indicator.actual_value | default(value="â€”") }}</div>
            <div><strong>ìƒíƒœ:</strong> {{ indicator.status | default(value="â€”") }}</div>
            <div><strong>ì„¤ëª…:</strong> {{ indicator.description | default(value="â€”") }}</div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê²Œì´ì§€ ì°¨íŠ¸ -->
        <div class="gauge-card" style="min-width: 200px; flex-shrink: 0;">
            <h4>ëª©í‘œ ë‹¬ì„±ë¥ </h4>
            <div class="gauge-wrapper">
                <canvas id="detail-gauge" width="150" height="150"></canvas>
                <div class="gauge-value" id="detail-gauge-value">â€”</div>
            </div>
            <div class="gauge-label">
                {{ indicator.actual_value | default(value="0") }} / {{ indicator.target_value | default(value="0") }} {{ indicator.unit | default(value="") }}
            </div>
            <span class="gauge-status" id="detail-gauge-status"></span>
        </div>
    </div>
</div>

<div class="tabs mt-20">
    <div class="tab active" onclick="showTab('input')">ì…ë ¥ì§€í‘œ</div>
    <div class="tab" onclick="showTab('process')">ê³¼ì •ì§€í‘œ</div>
    <div class="tab" onclick="showTab('output')">ì‚°ì¶œì§€í‘œ</div>
    <div class="tab" onclick="showTab('outcome')">ê²°ê³¼ì§€í‘œ</div>
</div>

<div id="tab-input" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>ì…ë ¥ì§€í‘œ (Input Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('input', 'create')">+ ì§€í‘œ ì¶”ê°€</button>
    </div>
    {% set indices = input_indices %}
    {% set index_type = "input" %}
    {% include "dashboard/_index_table.html" %}
</div>
<div id="tab-process" class="tab-content" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>ê³¼ì •ì§€í‘œ (Process Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('process', 'create')">+ ì§€í‘œ ì¶”ê°€</button>
    </div>
    {% set indices = process_indices %}
    {% set index_type = "process" %}
    {% include "dashboard/_index_table.html" %}
</div>
<div id="tab-output" class="tab-content" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>ì‚°ì¶œì§€í‘œ (Output Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('output', 'create')">+ ì§€í‘œ ì¶”ê°€</button>
    </div>
    {% set indices = output_indices %}
    {% set index_type = "output" %}
    {% include "dashboard/_index_table.html" %}
</div>
<div id="tab-outcome" class="tab-content" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>ê²°ê³¼ì§€í‘œ (Outcome Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('outcome', 'create')">+ ì§€í‘œ ì¶”ê°€</button>
    </div>
    {% set indices = outcome_indices %}
    {% set index_type = "outcome" %}
    {% include "dashboard/_index_table.html" %}
</div>

<div class="mt-20">
    <a href="/" class="btn btn-primary">ëª©ë¡ìœ¼ë¡œ</a>
</div>

<!-- Modal -->
<div id="indexModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; overflow-y:auto;">
    <div style="background:white; width:800px; margin:50px auto; padding:20px; border-radius:8px; display:flex; gap:20px;">
        <!-- ì™¼ìª½: AI ì–´ì‹œìŠ¤í„´íŠ¸ -->
        <div id="aiAssistantPanel" style="flex:1; border-right:1px solid #eee; padding-right:20px;">
            <h3 class="mb-10" style="display:flex; align-items:center; gap:8px;">
                <span style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:4px 8px; border-radius:4px; font-size:12px;">AI</span>
                AI ì–´ì‹œìŠ¤í„´íŠ¸
            </h3>

            <div id="chatMessages" style="height:280px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:8px; padding:12px; background:#f9f9f9; margin-bottom:12px;">
                <div class="ai-message" style="background:white; padding:10px; border-radius:8px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.1);">
                    <strong style="color:#667eea;">ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸</strong>
                    <p style="margin:8px 0 0; color:#555;">ì•ˆë…•í•˜ì„¸ìš”! ì§€í‘œ ì¶”ê°€ë¥¼ ë„ì™€ë“œë¦´ê²Œìš”. ì–´ë–¤ ì§€í‘œë¥¼ ë§Œë“¤ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? ì˜ˆë¥¼ ë“¤ì–´:</p>
                    <ul style="margin:8px 0; padding-left:20px; color:#666; font-size:14px;">
                        <li>"ì˜ˆì‚° ê´€ë ¨ ì§€í‘œë¥¼ ì¶”ì²œí•´ì¤˜"</li>
                        <li>"ì¸ë ¥ íˆ¬ì… í˜„í™©ì„ ì¸¡ì •í•˜ê³  ì‹¶ì–´"</li>
                        <li>"ê³ ê° ë§Œì¡±ë„ ì§€í‘œê°€ í•„ìš”í•´"</li>
                    </ul>
                </div>
            </div>

            <div style="display:flex; gap:8px;">
                <input type="text" id="aiInput" placeholder="AIì—ê²Œ ì§€í‘œ ì¶”ì²œ ìš”ì²­..."
                    style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;"
                    onkeypress="if(event.key==='Enter') askAI()">
                <button type="button" onclick="askAI()" class="btn btn-primary"
                    style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none;">
                    ì „ì†¡
                </button>
            </div>

            <!-- AI ì¶”ì²œ ê²°ê³¼ -->
            <div id="aiSuggestions" style="margin-top:12px; display:none;">
                <h4 style="font-size:14px; color:#555; margin-bottom:8px;">ğŸ“‹ ì¶”ì²œ ì§€í‘œ (í´ë¦­í•˜ì—¬ ì ìš©)</h4>
                <div id="suggestionCards" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê¸°ì¡´ í¼ -->
        <div style="flex:1;">
            <h3 id="modalTitle" class="mb-10">ì§€í‘œ ê´€ë¦¬</h3>
            <form id="indexForm" onsubmit="event.preventDefault(); saveIndex();">
                <input type="hidden" id="indexId">
                <input type="hidden" id="indexType">
                <input type="hidden" id="actionMode">

                <div class="form-group">
                    <label>ì§€í‘œëª…</label>
                    <input type="text" id="indexName" required>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>ëª©í‘œê°’</label>
                        <input type="number" step="any" id="indexTarget">
                    </div>
                    <div class="form-group">
                        <label>ì‹¤ì ê°’</label>
                        <input type="number" step="any" id="indexActual">
                    </div>
                </div>

                <div class="form-group">
                    <label>ê°€ì¤‘ì¹˜</label>
                    <input type="number" step="any" id="indexWeight" value="1.0">
                </div>

                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="indexDesc" rows="3"></textarea>
                </div>

                <div class="text-right mt-20">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Data passed from backend for JS usage (optional, but handling via DOM/Fetch is easier here)
    const PI_ID = parseInt("{{ indicator.id }}");

    // ì„±ê³¼ì§€í‘œ ë°ì´í„°
    const indicatorData = {
        targetValue: {{ indicator.target_value | default(value="null") }},
        actualValue: {{ indicator.actual_value | default(value="null") }}
    };

    // ë‹¬ì„±ë¥ ì— ë”°ë¥¸ ê²Œì´ì§€ ìƒ‰ìƒ ê²°ì •
    function getGaugeColor(percentage) {
        if (percentage >= 100) return { main: '#27ae60', bg: '#e8f8f5' };
        if (percentage >= 80) return { main: '#3498db', bg: '#ebf5fb' };
        if (percentage >= 50) return { main: '#f39c12', bg: '#fef9e7' };
        return { main: '#e74c3c', bg: '#fdedec' };
    }

    // ë‹¬ì„±ë¥ ì— ë”°ë¥¸ ìƒíƒœ ë¼ë²¨ ê²°ì •
    function getStatusLabel(percentage) {
        if (percentage >= 100) return { text: 'ëª©í‘œ ë‹¬ì„±' };
        if (percentage >= 80) return { text: 'ì–‘í˜¸' };
        if (percentage >= 50) return { text: 'ì£¼ì˜' };
        return { text: 'ë¯¸ë‹¬' };
    }

    // HEX ìƒ‰ìƒì˜ ë³´ìƒ‰ ê³„ì‚°
    function getComplementaryColor(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const compR = 255 - r;
        const compG = 255 - g;
        const compB = 255 - b;
        return `#${compR.toString(16).padStart(2, '0')}${compG.toString(16).padStart(2, '0')}${compB.toString(16).padStart(2, '0')}`;
    }

    // ë³´ìƒ‰ì˜ ì—°í•œ ë²„ì „ ìƒì„± (ë°°ê²½ìš©)
    function getLighterColor(hex, factor = 0.85) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const lightR = Math.round(r + (255 - r) * factor);
        const lightG = Math.round(g + (255 - g) * factor);
        const lightB = Math.round(b + (255 - b) * factor);
        return `#${lightR.toString(16).padStart(2, '0')}${lightG.toString(16).padStart(2, '0')}${lightB.toString(16).padStart(2, '0')}`;
    }

    // ë³´ìƒ‰ì˜ ì–´ë‘ìš´ ë²„ì „ ìƒì„± (í…ìŠ¤íŠ¸ìš©)
    function getDarkerColor(hex, factor = 0.4) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const darkR = Math.round(r * factor);
        const darkG = Math.round(g * factor);
        const darkB = Math.round(b * factor);
        return `#${darkR.toString(16).padStart(2, '0')}${darkG.toString(16).padStart(2, '0')}${darkB.toString(16).padStart(2, '0')}`;
    }

    // ë°˜ì›í˜• ê²Œì´ì§€ ì°¨íŠ¸ ìƒì„±
    function createGaugeChart(canvasId, percentage, color) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        const displayPercentage = Math.min(percentage, 100);
        const remaining = 100 - displayPercentage;

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [displayPercentage, remaining],
                    backgroundColor: [color.main, color.bg],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    }

    // ê²Œì´ì§€ ì°¨íŠ¸ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        const target = indicatorData.targetValue;
        const actual = indicatorData.actualValue;

        let percentage = 0;
        if (target && target > 0 && actual !== null) {
            percentage = (actual / target) * 100;
        }

        const color = getGaugeColor(percentage);
        const status = getStatusLabel(percentage);

        // ê²Œì´ì§€ ì°¨íŠ¸ ìƒì„±
        createGaugeChart('detail-gauge', percentage, color);

        // ë‹¬ì„±ë¥  í‘œì‹œ
        const valueEl = document.getElementById('detail-gauge-value');
        if (valueEl) {
            valueEl.textContent = `${percentage.toFixed(1)}%`;
            valueEl.style.color = color.main;
        }

        // ìƒíƒœ ë¼ë²¨ í‘œì‹œ (ë³´ìƒ‰ ì ìš©)
        const statusEl = document.getElementById('detail-gauge-status');
        if (statusEl) {
            statusEl.textContent = status.text;
            const complementary = getComplementaryColor(color.main);
            statusEl.style.backgroundColor = getLighterColor(complementary);
            statusEl.style.color = getDarkerColor(complementary);
        }
    });

    function showTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + name).style.display = 'block';
        event.target.classList.add('active');
    }

    function openModal(type, mode, data = null) {
        document.getElementById('indexModal').style.display = 'block';
        document.getElementById('indexType').value = type;
        document.getElementById('actionMode').value = mode;

        // Reset form
        document.getElementById('indexForm').reset();

        if (mode === 'edit' && data) {
            document.getElementById('modalTitle').innerText = 'ì§€í‘œ ìˆ˜ì •';
            document.getElementById('indexId').value = data.id;
            document.getElementById('indexName').value = data.name;
            document.getElementById('indexTarget').value = data.target_value || '';
            document.getElementById('indexActual').value = data.actual_value || '';
            document.getElementById('indexWeight').value = data.weight || '';
            document.getElementById('indexDesc').value = data.description || '';
        } else {
            document.getElementById('modalTitle').innerText = 'ì§€í‘œ ì¶”ê°€';
        }
    }

    function closeModal() {
        document.getElementById('indexModal').style.display = 'none';
    }

    async function saveIndex() {
        const type = document.getElementById('indexType').value;
        const mode = document.getElementById('actionMode').value;
        const id = document.getElementById('indexId').value;

        const payload = {
            name: document.getElementById('indexName').value,
            description: document.getElementById('indexDesc').value || null,
            target_value: document.getElementById('indexTarget').value ? parseFloat(document.getElementById('indexTarget').value) : null,
            actual_value: document.getElementById('indexActual').value ? parseFloat(document.getElementById('indexActual').value) : null,
            weight: document.getElementById('indexWeight').value ? parseFloat(document.getElementById('indexWeight').value) : null,
        };

        let url = `/api/${type}-indices`;
        let method = 'POST';

        if (mode === 'create') {
            payload.performance_indicator_id = PI_ID;
        } else {
            url += `/${id}`;
            method = 'PUT';
        }

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + res.statusText);
            }
        } catch (e) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + e);
        }
    }

    async function deleteIndex(type, id) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch(`/api/${type}-indices/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (e) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + e);
        }
    }

    // â”€â”€ AI ì–´ì‹œìŠ¤í„´íŠ¸ ê¸°ëŠ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const indicatorInfo = {
        name: "{{ indicator.name }}",
        description: "{{ indicator.description | default(value='') }}"
    };

    // ì•ˆì „í•œ í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.textContent;
    }

    function createChatMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = role === 'user' ? 'user-message' : 'ai-message';
        messageDiv.style.cssText = role === 'user'
            ? 'background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:8px; text-align:right;'
            : 'background:white; padding:10px; border-radius:8px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.1);';

        const header = document.createElement('strong');
        header.style.color = role === 'user' ? '#1976d2' : '#667eea';
        header.textContent = role === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸';

        const text = document.createElement('p');
        text.style.cssText = 'margin:8px 0 0; color:' + (role === 'user' ? '#333' : '#555') + ';';
        text.textContent = content;

        messageDiv.appendChild(header);
        messageDiv.appendChild(text);
        return messageDiv;
    }

    function addChatMessage(role, content) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.appendChild(createChatMessage(role, content));
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addSuccessMessage(name) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message';
        messageDiv.style.cssText = 'background:white; padding:10px; border-radius:8px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.1);';

        const header = document.createElement('strong');
        header.style.color = '#667eea';
        header.textContent = 'ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸';

        const text = document.createElement('p');
        text.style.cssText = 'margin:8px 0 0; color:#27ae60;';
        text.textContent = 'âœ… "' + escapeHtml(name) + '" ì§€í‘œê°€ í¼ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ê²½ìš° ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.';

        messageDiv.appendChild(header);
        messageDiv.appendChild(text);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addErrorMessage(error) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message';
        messageDiv.style.cssText = 'background:white; padding:10px; border-radius:8px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.1);';

        const header = document.createElement('strong');
        header.style.color = '#667eea';
        header.textContent = 'ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸';

        const text = document.createElement('p');
        text.style.cssText = 'margin:8px 0 0; color:#e74c3c;';
        text.textContent = 'âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + escapeHtml(error);

        messageDiv.appendChild(header);
        messageDiv.appendChild(text);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showLoadingMessage() {
        const chatMessages = document.getElementById('chatMessages');
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'aiLoading';
        loadingDiv.className = 'ai-message';
        loadingDiv.style.cssText = 'background:white; padding:10px; border-radius:8px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.1);';

        const header = document.createElement('strong');
        header.style.color = '#667eea';
        header.textContent = 'ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸';

        const text = document.createElement('p');
        text.style.cssText = 'margin:8px 0 0; color:#888;';
        const dotsSpan = document.createElement('span');
        dotsSpan.className = 'loading-dots';
        dotsSpan.textContent = 'ìƒê° ì¤‘';
        text.appendChild(dotsSpan);

        loadingDiv.appendChild(header);
        loadingDiv.appendChild(text);
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
        let dots = 0;
        window.loadingInterval = setInterval(() => {
            dots = (dots + 1) % 4;
            dotsSpan.textContent = 'ìƒê° ì¤‘' + '.'.repeat(dots);
        }, 500);
    }

    function hideLoadingMessage() {
        if (window.loadingInterval) clearInterval(window.loadingInterval);
        const loadingDiv = document.getElementById('aiLoading');
        if (loadingDiv) loadingDiv.remove();
    }

    function createSuggestionCard(suggestion, index) {
        const card = document.createElement('div');
        card.style.cssText = 'background:linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding:12px; border-radius:8px; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;';
        card.onmouseenter = () => { card.style.transform = 'translateY(-2px)'; card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; };
        card.onmouseleave = () => { card.style.transform = 'none'; card.style.boxShadow = 'none'; };
        card.onclick = () => applySuggestion(suggestion);

        const headerRow = document.createElement('div');
        headerRow.style.cssText = 'display:flex; justify-content:space-between; align-items:center;';

        const title = document.createElement('strong');
        title.style.color = '#333';
        title.textContent = suggestion.name;

        const badge = document.createElement('span');
        badge.style.cssText = 'background:#667eea; color:white; padding:2px 8px; border-radius:12px; font-size:11px;';
        badge.textContent = 'í´ë¦­í•˜ì—¬ ì ìš©';

        headerRow.appendChild(title);
        headerRow.appendChild(badge);
        card.appendChild(headerRow);

        if (suggestion.description) {
            const desc = document.createElement('p');
            desc.style.cssText = 'margin:6px 0 0; font-size:13px; color:#666;';
            desc.textContent = suggestion.description;
            card.appendChild(desc);
        }

        const meta = document.createElement('div');
        meta.style.cssText = 'margin-top:8px; font-size:12px; color:#888;';
        const metaParts = [];
        if (suggestion.target_value) metaParts.push('ëª©í‘œê°’: ' + suggestion.target_value);
        if (suggestion.weight) metaParts.push('ê°€ì¤‘ì¹˜: ' + suggestion.weight);
        meta.textContent = metaParts.join(' | ');
        card.appendChild(meta);

        return card;
    }

    function displaySuggestions(suggestions) {
        const suggestionsPanel = document.getElementById('aiSuggestions');
        const cardsContainer = document.getElementById('suggestionCards');

        if (!suggestions || suggestions.length === 0) {
            suggestionsPanel.style.display = 'none';
            return;
        }

        cardsContainer.replaceChildren();
        suggestions.forEach((suggestion, index) => {
            cardsContainer.appendChild(createSuggestionCard(suggestion, index));
        });

        suggestionsPanel.style.display = 'block';
    }

    function applySuggestion(suggestion) {
        document.getElementById('indexName').value = suggestion.name || '';
        document.getElementById('indexDesc').value = suggestion.description || '';
        document.getElementById('indexTarget').value = suggestion.target_value || '';
        document.getElementById('indexWeight').value = suggestion.weight || 1.0;

        addSuccessMessage(suggestion.name);
    }

    async function askAI() {
        const input = document.getElementById('aiInput');
        const message = input.value.trim();
        if (!message) return;

        const indexType = document.getElementById('indexType').value;

        // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        addChatMessage('user', message);
        input.value = '';

        // ë¡œë”© í‘œì‹œ
        showLoadingMessage();

        try {
            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    index_type: indexType,
                    indicator_name: indicatorInfo.name,
                    indicator_description: indicatorInfo.description
                })
            });

            hideLoadingMessage();

            if (!response.ok) {
                const errorText = await response.text();
                addErrorMessage(errorText);
                return;
            }

            const data = await response.json();
            console.log('AI ì‘ë‹µ ë°ì´í„°:', JSON.stringify(data, null, 2));

            // AI ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ
            addChatMessage('ai', data.message || 'ì¶”ì²œ ì§€í‘œë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.');

            // ì¶”ì²œ ì§€í‘œ ì¹´ë“œ í‘œì‹œ ë° ì²« ë²ˆì§¸ ì§€í‘œ ìë™ ì ìš©
            console.log('suggestions:', data.suggestions);
            if (data.suggestions && data.suggestions.length > 0) {
                console.log('ì²« ë²ˆì§¸ ì¶”ì²œ:', data.suggestions[0]);
                displaySuggestions(data.suggestions);
                // ì²« ë²ˆì§¸ ì¶”ì²œ ì§€í‘œë¥¼ í¼ì— ìë™ ì ìš©
                applySuggestion(data.suggestions[0]);
            } else {
                console.log('suggestionsê°€ ë¹„ì–´ìˆê±°ë‚˜ ì—†ìŒ');
            }
        } catch (error) {
            hideLoadingMessage();
            addErrorMessage(error.message);
        }
    }

    // AI íŒ¨ë„ ì´ˆê¸°í™” (ëª¨ë‹¬ ì—´ ë•Œ)
    function resetAIPanel() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.replaceChildren();

        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'ai-message';
        welcomeDiv.style.cssText = 'background:white; padding:10px; border-radius:8px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.1);';

        const header = document.createElement('strong');
        header.style.color = '#667eea';
        header.textContent = 'ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸';

        const intro = document.createElement('p');
        intro.style.cssText = 'margin:8px 0 0; color:#555;';
        intro.textContent = 'ì•ˆë…•í•˜ì„¸ìš”! ì§€í‘œ ì¶”ê°€ë¥¼ ë„ì™€ë“œë¦´ê²Œìš”. ì–´ë–¤ ì§€í‘œë¥¼ ë§Œë“¤ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? ì˜ˆë¥¼ ë“¤ì–´:';

        const examples = document.createElement('ul');
        examples.style.cssText = 'margin:8px 0; padding-left:20px; color:#666; font-size:14px;';
        ['ì˜ˆì‚° ê´€ë ¨ ì§€í‘œë¥¼ ì¶”ì²œí•´ì¤˜', 'ì¸ë ¥ íˆ¬ì… í˜„í™©ì„ ì¸¡ì •í•˜ê³  ì‹¶ì–´', 'ê³ ê° ë§Œì¡±ë„ ì§€í‘œê°€ í•„ìš”í•´'].forEach(text => {
            const li = document.createElement('li');
            li.textContent = '"' + text + '"';
            examples.appendChild(li);
        });

        welcomeDiv.appendChild(header);
        welcomeDiv.appendChild(intro);
        welcomeDiv.appendChild(examples);
        chatMessages.appendChild(welcomeDiv);

        document.getElementById('aiSuggestions').style.display = 'none';
        document.getElementById('aiInput').value = '';
    }

    // ì›ë˜ openModal í•¨ìˆ˜ í™•ì¥
    const originalOpenModal = openModal;
    openModal = function(type, mode, data = null) {
        originalOpenModal(type, mode, data);
        if (mode === 'create') {
            resetAIPanel();
            document.getElementById('aiAssistantPanel').style.display = 'block';
        } else {
            // ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” AI íŒ¨ë„ ìˆ¨ê¹€
            document.getElementById('aiAssistantPanel').style.display = 'none';
        }
    };
</script>
{% endblock %}