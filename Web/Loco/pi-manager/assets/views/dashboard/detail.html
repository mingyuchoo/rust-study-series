{% extends "base.html" %}

{% block title %}{{ indicator.name }} - 성과지표 상세{% endblock %}

{% block content %}
<div class="card mt-20">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>{{ indicator.name }}</h2>
        <span
            class="score-badge {% if score >= 80 %}score-high{% elif score >= 50 %}score-mid{% else %}score-low{% endif %}">
            종합점수: {{ score | round(precision=1) }}%
        </span>
    </div>

    <!-- 정보 + 게이지 차트 섹션 -->
    <div style="display: flex; gap: 30px; align-items: flex-start; margin-top: 20px;">
        <!-- 왼쪽: 정보 그리드 -->
        <div class="grid-2" style="flex: 1;">
            <div><strong>연도:</strong> {{ indicator.year }}</div>
            <div><strong>단위:</strong> {{ indicator.unit | default(value="—") }}</div>
            <div><strong>목표값:</strong> {{ indicator.target_value | default(value="—") }}</div>
            <div><strong>실적값:</strong> {{ indicator.actual_value | default(value="—") }}</div>
            <div><strong>상태:</strong> {{ indicator.status | default(value="—") }}</div>
            <div><strong>설명:</strong> {{ indicator.description | default(value="—") }}</div>
        </div>

        <!-- 오른쪽: 게이지 차트 -->
        <div class="gauge-card" style="min-width: 200px; flex-shrink: 0;">
            <h4>목표 달성률</h4>
            <div class="gauge-wrapper">
                <canvas id="detail-gauge" width="150" height="150"></canvas>
                <div class="gauge-value" id="detail-gauge-value">—</div>
            </div>
            <div class="gauge-label">
                {{ indicator.actual_value | default(value="0") }} / {{ indicator.target_value | default(value="0") }} {{ indicator.unit | default(value="") }}
            </div>
            <span class="gauge-status" id="detail-gauge-status"></span>
        </div>
    </div>
</div>

<div class="tabs mt-20">
    <div class="tab active" onclick="showTab('input')">입력지표</div>
    <div class="tab" onclick="showTab('process')">과정지표</div>
    <div class="tab" onclick="showTab('output')">산출지표</div>
    <div class="tab" onclick="showTab('outcome')">결과지표</div>
</div>

<div id="tab-input" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>입력지표 (Input Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('input', 'create')">+ 지표 추가</button>
    </div>
    {% set indices = input_indices %}
    {% set index_type = "input" %}
    {% include "dashboard/_index_table.html" %}
</div>
<div id="tab-process" class="tab-content" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>과정지표 (Process Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('process', 'create')">+ 지표 추가</button>
    </div>
    {% set indices = process_indices %}
    {% set index_type = "process" %}
    {% include "dashboard/_index_table.html" %}
</div>
<div id="tab-output" class="tab-content" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>산출지표 (Output Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('output', 'create')">+ 지표 추가</button>
    </div>
    {% set indices = output_indices %}
    {% set index_type = "output" %}
    {% include "dashboard/_index_table.html" %}
</div>
<div id="tab-outcome" class="tab-content" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center;" class="mb-10">
        <h3>결과지표 (Outcome Index)</h3>
        <button class="btn btn-sm btn-success" onclick="openModal('outcome', 'create')">+ 지표 추가</button>
    </div>
    {% set indices = outcome_indices %}
    {% set index_type = "outcome" %}
    {% include "dashboard/_index_table.html" %}
</div>

<div class="mt-20">
    <a href="/" class="btn btn-primary">목록으로</a>
</div>

<!-- Modal -->
<div id="indexModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:white; width:500px; margin:100px auto; padding:20px; border-radius:8px;">
        <h3 id="modalTitle" class="mb-10">지표 관리</h3>
        <form id="indexForm" onsubmit="event.preventDefault(); saveIndex();">
            <input type="hidden" id="indexId">
            <input type="hidden" id="indexType">
            <input type="hidden" id="actionMode">

            <div class="form-group">
                <label>지표명</label>
                <input type="text" id="indexName" required>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>목표값</label>
                    <input type="number" step="any" id="indexTarget">
                </div>
                <div class="form-group">
                    <label>실적값</label>
                    <input type="number" step="any" id="indexActual">
                </div>
            </div>

            <div class="form-group">
                <label>가중치</label>
                <input type="number" step="any" id="indexWeight" value="1.0">
            </div>

            <div class="form-group">
                <label>설명</label>
                <textarea id="indexDesc" rows="3"></textarea>
            </div>

            <div class="text-right mt-20">
                <button type="button" class="btn btn-danger" onclick="closeModal()">취소</button>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Data passed from backend for JS usage (optional, but handling via DOM/Fetch is easier here)
    const PI_ID = parseInt("{{ indicator.id }}");

    // 성과지표 데이터
    const indicatorData = {
        targetValue: {{ indicator.target_value | default(value="null") }},
        actualValue: {{ indicator.actual_value | default(value="null") }}
    };

    // 달성률에 따른 게이지 색상 결정
    function getGaugeColor(percentage) {
        if (percentage >= 100) return { main: '#27ae60', bg: '#e8f8f5' };
        if (percentage >= 80) return { main: '#3498db', bg: '#ebf5fb' };
        if (percentage >= 50) return { main: '#f39c12', bg: '#fef9e7' };
        return { main: '#e74c3c', bg: '#fdedec' };
    }

    // 달성률에 따른 상태 라벨 결정
    function getStatusLabel(percentage) {
        if (percentage >= 100) return { text: '목표 달성' };
        if (percentage >= 80) return { text: '양호' };
        if (percentage >= 50) return { text: '주의' };
        return { text: '미달' };
    }

    // HEX 색상의 보색 계산
    function getComplementaryColor(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const compR = 255 - r;
        const compG = 255 - g;
        const compB = 255 - b;
        return `#${compR.toString(16).padStart(2, '0')}${compG.toString(16).padStart(2, '0')}${compB.toString(16).padStart(2, '0')}`;
    }

    // 보색의 연한 버전 생성 (배경용)
    function getLighterColor(hex, factor = 0.85) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const lightR = Math.round(r + (255 - r) * factor);
        const lightG = Math.round(g + (255 - g) * factor);
        const lightB = Math.round(b + (255 - b) * factor);
        return `#${lightR.toString(16).padStart(2, '0')}${lightG.toString(16).padStart(2, '0')}${lightB.toString(16).padStart(2, '0')}`;
    }

    // 보색의 어두운 버전 생성 (텍스트용)
    function getDarkerColor(hex, factor = 0.4) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const darkR = Math.round(r * factor);
        const darkG = Math.round(g * factor);
        const darkB = Math.round(b * factor);
        return `#${darkR.toString(16).padStart(2, '0')}${darkG.toString(16).padStart(2, '0')}${darkB.toString(16).padStart(2, '0')}`;
    }

    // 반원형 게이지 차트 생성
    function createGaugeChart(canvasId, percentage, color) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        const displayPercentage = Math.min(percentage, 100);
        const remaining = 100 - displayPercentage;

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [displayPercentage, remaining],
                    backgroundColor: [color.main, color.bg],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    }

    // 게이지 차트 초기화
    document.addEventListener('DOMContentLoaded', function() {
        const target = indicatorData.targetValue;
        const actual = indicatorData.actualValue;

        let percentage = 0;
        if (target && target > 0 && actual !== null) {
            percentage = (actual / target) * 100;
        }

        const color = getGaugeColor(percentage);
        const status = getStatusLabel(percentage);

        // 게이지 차트 생성
        createGaugeChart('detail-gauge', percentage, color);

        // 달성률 표시
        const valueEl = document.getElementById('detail-gauge-value');
        if (valueEl) {
            valueEl.textContent = `${percentage.toFixed(1)}%`;
            valueEl.style.color = color.main;
        }

        // 상태 라벨 표시 (보색 적용)
        const statusEl = document.getElementById('detail-gauge-status');
        if (statusEl) {
            statusEl.textContent = status.text;
            const complementary = getComplementaryColor(color.main);
            statusEl.style.backgroundColor = getLighterColor(complementary);
            statusEl.style.color = getDarkerColor(complementary);
        }
    });

    function showTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + name).style.display = 'block';
        event.target.classList.add('active');
    }

    function openModal(type, mode, data = null) {
        document.getElementById('indexModal').style.display = 'block';
        document.getElementById('indexType').value = type;
        document.getElementById('actionMode').value = mode;

        // Reset form
        document.getElementById('indexForm').reset();

        if (mode === 'edit' && data) {
            document.getElementById('modalTitle').innerText = '지표 수정';
            document.getElementById('indexId').value = data.id;
            document.getElementById('indexName').value = data.name;
            document.getElementById('indexTarget').value = data.target_value || '';
            document.getElementById('indexActual').value = data.actual_value || '';
            document.getElementById('indexWeight').value = data.weight || '';
            document.getElementById('indexDesc').value = data.description || '';
        } else {
            document.getElementById('modalTitle').innerText = '지표 추가';
        }
    }

    function closeModal() {
        document.getElementById('indexModal').style.display = 'none';
    }

    async function saveIndex() {
        const type = document.getElementById('indexType').value;
        const mode = document.getElementById('actionMode').value;
        const id = document.getElementById('indexId').value;

        const payload = {
            name: document.getElementById('indexName').value,
            description: document.getElementById('indexDesc').value || null,
            target_value: document.getElementById('indexTarget').value ? parseFloat(document.getElementById('indexTarget').value) : null,
            actual_value: document.getElementById('indexActual').value ? parseFloat(document.getElementById('indexActual').value) : null,
            weight: document.getElementById('indexWeight').value ? parseFloat(document.getElementById('indexWeight').value) : null,
        };

        let url = `/api/${type}-indices`;
        let method = 'POST';

        if (mode === 'create') {
            payload.performance_indicator_id = PI_ID;
        } else {
            url += `/${id}`;
            method = 'PUT';
        }

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert('저장 실패: ' + res.statusText);
            }
        } catch (e) {
            alert('오류 발생: ' + e);
        }
    }

    async function deleteIndex(type, id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;

        try {
            const res = await fetch(`/api/${type}-indices/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert('삭제 실패');
            }
        } catch (e) {
            alert('오류 발생: ' + e);
        }
    }
</script>
{% endblock %}