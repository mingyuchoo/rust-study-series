{% extends "layouts/base.html" %}

{% block title %}MusicLoop - Discover Music{% endblock %}

{% block content %}
<h1 class="page-title">Public Tracks</h1>
<div id="track-list">
    <p style="color:#888;">Loading tracks...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
function createEl(tag, attrs, children) {
    const el = document.createElement(tag);
    if (attrs) Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'textContent') el.textContent = v;
        else if (k.startsWith('on')) el.addEventListener(k.slice(2), v);
        else el.setAttribute(k, v);
    });
    if (children) children.forEach(c => { if (c) el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
    return el;
}

function buildTrackCard(t) {
    const playBtn = createEl('span', { class: 'play-btn', title: 'Play', textContent: '\u25B6' });
    playBtn.addEventListener('click', () => playTrack(t.id, t.title, t.artist || '', t.url));

    const titleLink = createEl('a', { href: '/tracks/' + t.id, style: 'color:#fff; text-decoration:none;' });
    titleLink.textContent = t.title;

    const titleDiv = createEl('div', { class: 'card-title' }, [playBtn, document.createTextNode(' '), titleLink]);

    const metaText = (t.artist ? t.artist + ' \u00B7 ' : '') + new Date(t.created_at).toLocaleDateString('ko-KR');
    const metaDiv = createEl('div', { class: 'card-meta', textContent: metaText });

    const leftDiv = createEl('div', {}, [titleDiv, metaDiv]);
    if (t.description) {
        leftDiv.appendChild(createEl('div', { class: 'card-desc', textContent: t.description }));
    }

    const upBtn = createEl('button', { class: 'vote-btn', title: 'Upvote', textContent: '\u25B2' });
    upBtn.addEventListener('click', () => doVote(t.id, 1));
    const scoreSpan = createEl('span', { class: 'vote-score', id: 'score-' + t.id, textContent: String(t.vote_score) });
    const downBtn = createEl('button', { class: 'vote-btn', title: 'Downvote', textContent: '\u25BC' });
    downBtn.addEventListener('click', () => doVote(t.id, -1));
    const voteBox = createEl('div', { class: 'vote-box' }, [upBtn, scoreSpan, downBtn]);

    const row = createEl('div', { style: 'display:flex; justify-content:space-between; align-items:flex-start;' }, [leftDiv, voteBox]);
    return createEl('div', { class: 'card' }, [row]);
}

async function loadTracks() {
    try {
        const resp = await fetch('/api/tracks');
        const data = await resp.json();
        const list = document.getElementById('track-list');
        list.textContent = '';

        if (!data.tracks || data.tracks.length === 0) {
            list.appendChild(createEl('p', { style: 'color:#888;', textContent: 'No public tracks yet. Be the first to share!' }));
            return;
        }

        data.tracks.forEach(t => list.appendChild(buildTrackCard(t)));
    } catch (err) {
        console.error(err);
    }
}

async function doVote(trackId, voteType) {
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/auth/login'; return; }
    try {
        const resp = await fetch('/api/tracks/' + trackId + '/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ vote_type: voteType })
        });
        if (resp.ok) {
            const tResp = await fetch('/api/tracks/' + trackId);
            const t = await tResp.json();
            const scoreEl = document.getElementById('score-' + trackId);
            if (scoreEl) scoreEl.textContent = String(t.vote_score);
        }
    } catch (err) { console.error(err); }
}

loadTracks();
</script>
{% endblock %}
