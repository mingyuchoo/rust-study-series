{% extends "layouts/base.html" %}

{% block title %}Track Detail - MusicLoop{% endblock %}

{% block content %}
<div id="track-detail">
    <p style="color:#888;">Loading...</p>
</div>
<div id="comments-section" style="margin-top:2rem;">
    <h2 class="page-title" style="font-size:1.2rem;">Comments</h2>
    <div class="comment-form" id="comment-form-box" style="display:none;">
        <textarea id="comment-input" placeholder="Write a comment..." rows="2"></textarea>
        <button class="btn btn-primary btn-sm" id="comment-submit">Post Comment</button>
    </div>
    <div id="comment-list"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const trackId = window.location.pathname.split('/').pop();

function createEl(tag, attrs, children) {
    const el = document.createElement(tag);
    if (attrs) Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'textContent') el.textContent = v;
        else if (k.startsWith('on')) el.addEventListener(k.slice(2), v);
        else el.setAttribute(k, v);
    });
    if (children) children.forEach(c => { if (c) el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
    return el;
}

async function loadTrack() {
    try {
        const resp = await fetch('/api/tracks/' + trackId);
        if (!resp.ok) { document.getElementById('track-detail').textContent = 'Track not found.'; return; }
        const t = await resp.json();

        const detail = document.getElementById('track-detail');
        detail.textContent = '';

        const playBtn = createEl('button', { class: 'btn btn-primary', textContent: '\u25B6 Play' });
        playBtn.addEventListener('click', () => playTrack(t.id, t.title, t.artist || '', t.url));

        const title = createEl('h1', { class: 'page-title', textContent: t.title });
        const meta = createEl('div', { class: 'card-meta', textContent: (t.artist || 'Unknown artist') + ' \u00B7 ' + new Date(t.created_at).toLocaleDateString('ko-KR') });

        const upBtn = createEl('button', { class: 'vote-btn', title: 'Upvote', textContent: '\u25B2' });
        upBtn.addEventListener('click', () => doVote(1));
        const score = createEl('span', { class: 'vote-score', id: 'detail-score', textContent: String(t.vote_score) });
        const downBtn = createEl('button', { class: 'vote-btn', title: 'Downvote', textContent: '\u25BC' });
        downBtn.addEventListener('click', () => doVote(-1));
        const voteBox = createEl('div', { class: 'vote-box', style: 'margin:1rem 0;' }, [upBtn, score, downBtn]);

        detail.appendChild(title);
        detail.appendChild(meta);
        if (t.description) detail.appendChild(createEl('div', { class: 'card-desc', style: 'margin:0.5rem 0;', textContent: t.description }));
        detail.appendChild(voteBox);
        detail.appendChild(playBtn);

        // Show comment form if logged in
        if (localStorage.getItem('token')) {
            document.getElementById('comment-form-box').style.display = 'block';
        }
    } catch (err) { console.error(err); }
}

async function doVote(voteType) {
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/auth/login'; return; }
    try {
        const resp = await fetch('/api/tracks/' + trackId + '/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ vote_type: voteType })
        });
        if (resp.ok) {
            const tResp = await fetch('/api/tracks/' + trackId);
            const t = await tResp.json();
            const scoreEl = document.getElementById('detail-score');
            if (scoreEl) scoreEl.textContent = String(t.vote_score);
        }
    } catch (err) { console.error(err); }
}

async function loadComments() {
    try {
        const resp = await fetch('/api/tracks/' + trackId + '/comments');
        const data = await resp.json();
        const list = document.getElementById('comment-list');
        list.textContent = '';

        if (!data.comments || data.comments.length === 0) {
            list.appendChild(createEl('p', { style: 'color:#888; margin-top:0.5rem;', textContent: 'No comments yet.' }));
            return;
        }

        data.comments.forEach(c => {
            const meta = createEl('div', { class: 'comment-meta', textContent: 'User #' + c.user_id + ' \u00B7 ' + new Date(c.created_at).toLocaleDateString('ko-KR') });
            const content = createEl('div', { class: 'comment-content', textContent: c.content });
            const item = createEl('div', { class: 'comment-item' }, [meta, content]);

            // Delete button if own comment
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user && c.user_id === user.id) {
                const delBtn = createEl('button', { class: 'btn btn-danger btn-sm', style: 'margin-top:0.25rem;', textContent: 'Delete' });
                delBtn.addEventListener('click', () => deleteComment(c.id));
                item.appendChild(delBtn);
            }

            list.appendChild(item);
        });
    } catch (err) { console.error(err); }
}

document.getElementById('comment-submit').addEventListener('click', async () => {
    const token = localStorage.getItem('token');
    const content = document.getElementById('comment-input').value.trim();
    if (!content || !token) return;
    try {
        const resp = await fetch('/api/tracks/' + trackId + '/comments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ content })
        });
        if (resp.ok) {
            document.getElementById('comment-input').value = '';
            loadComments();
        }
    } catch (err) { console.error(err); }
});

async function deleteComment(commentId) {
    const token = localStorage.getItem('token');
    if (!token) return;
    try {
        await fetch('/api/tracks/' + trackId + '/comments/' + commentId, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        loadComments();
    } catch (err) { console.error(err); }
}

loadTrack();
loadComments();
</script>
{% endblock %}
