{% extends "layouts/base.html" %}

{% block title %}My Tracks - MusicLoop{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center;">
    <h1 class="page-title">My Tracks</h1>
    <a href="/tracks/new" class="btn btn-primary">+ Add Track</a>
</div>
<div id="my-track-list">
    <p style="color:#888;">Loading...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
function createEl(tag, attrs, children) {
    const el = document.createElement(tag);
    if (attrs) Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'textContent') el.textContent = v;
        else el.setAttribute(k, v);
    });
    if (children) children.forEach(c => { if (c) el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
    return el;
}

async function loadMyTracks() {
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/auth/login'; return; }
    try {
        const resp = await fetch('/api/tracks/my', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await resp.json();
        const list = document.getElementById('my-track-list');
        list.textContent = '';

        if (!data.tracks || data.tracks.length === 0) {
            list.appendChild(createEl('p', { style: 'color:#888;', textContent: 'No tracks yet. Add your first track!' }));
            return;
        }

        data.tracks.forEach(t => {
            const title = createEl('div', { class: 'card-title', textContent: t.title });
            const meta = createEl('div', { class: 'card-meta', textContent: (t.artist || '') + ' \u00B7 ' + (t.is_public ? 'Public' : 'Private') + ' \u00B7 Score: ' + t.vote_score });

            const toggleBtn = createEl('button', { class: 'btn btn-outline btn-sm', textContent: t.is_public ? 'Make Private' : 'Make Public' });
            toggleBtn.addEventListener('click', () => togglePublic(t.id));

            const editLink = createEl('a', { href: '/tracks/' + t.id + '/edit', class: 'btn btn-outline btn-sm', textContent: 'Edit' });

            const delBtn = createEl('button', { class: 'btn btn-danger btn-sm', textContent: 'Delete' });
            delBtn.addEventListener('click', () => deleteTrack(t.id));

            const actions = createEl('div', { style: 'display:flex; gap:0.5rem; margin-top:0.5rem;' }, [toggleBtn, editLink, delBtn]);
            const card = createEl('div', { class: 'card' }, [title, meta, actions]);
            list.appendChild(card);
        });
    } catch (err) { console.error(err); }
}

async function togglePublic(id) {
    const token = localStorage.getItem('token');
    try {
        await fetch('/api/tracks/' + id + '/toggle-public', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        loadMyTracks();
    } catch (err) { console.error(err); }
}

async function deleteTrack(id) {
    if (!confirm('Are you sure?')) return;
    const token = localStorage.getItem('token');
    try {
        await fetch('/api/tracks/' + id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        loadMyTracks();
    } catch (err) { console.error(err); }
}

loadMyTracks();
</script>
{% endblock %}
