{% extends "layouts/base.html" %}

{% block title %}Edit Track - MusicLoop{% endblock %}

{% block content %}
<div class="auth-box" style="max-width:600px;">
    <h2 class="page-title" style="margin-top:0;">Edit Track</h2>
    <form id="edit-form">
        <div class="form-group">
            <label for="title">Title *</label>
            <input type="text" id="title" name="title" required>
        </div>
        <div class="form-group">
            <label for="artist">Artist</label>
            <input type="text" id="artist" name="artist">
        </div>
        <div class="form-group">
            <label for="url">URL *</label>
            <input type="url" id="url" name="url" required>
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Save Changes</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const trackId = window.location.pathname.split('/').filter(Boolean).find((_, i, a) => a[i-1] === 'tracks');

async function loadTrack() {
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/auth/login'; return; }
    try {
        const resp = await fetch('/api/tracks/' + trackId + '/detail', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!resp.ok) { alert('Track not found'); return; }
        const t = await resp.json();
        document.getElementById('title').value = t.title;
        document.getElementById('artist').value = t.artist || '';
        document.getElementById('url').value = t.url;
        document.getElementById('description').value = t.description || '';
    } catch (err) { console.error(err); }
}

document.getElementById('edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/auth/login'; return; }
    const body = {
        title: document.getElementById('title').value,
        url: document.getElementById('url').value,
    };
    const artist = document.getElementById('artist').value.trim();
    if (artist) body.artist = artist;
    const desc = document.getElementById('description').value.trim();
    if (desc) body.description = desc;

    try {
        const resp = await fetch('/api/tracks/' + trackId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(body)
        });
        if (resp.ok) {
            window.location.href = '/my/tracks';
        } else {
            const data = await resp.json();
            alert(data.description || 'Failed to update track');
        }
    } catch (err) { console.error(err); }
});

loadTrack();
</script>
{% endblock %}
